name: all
# 授予工作流写入仓库内容的权限
permissions:
  contents: write
on:
   #push:
     #paths:
      #- 'gengxinip.py'
   schedule:
        - cron: '12 1,4,7,10,13,23 * * *'
   workflow_dispatch:
 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # 升级到最新版，更稳定

      - name: Set up Python
        uses: actions/setup-python@v5  # 升级到最新版
        with:
          python-version: 3.x
      - name: 安装系统依赖（Chrome + 正确下载 ChromeDriver）
        run: |
          # 安装 Chrome 浏览器
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
          
          # 关键修复：提取 Chrome 完整版本号（格式：主.次.修.补）
          CHROME_FULL_VERSION=$(google-chrome --version | grep -oP '(\d+\.){3}\d+')
          echo "获取到 Chrome 完整版本号：$CHROME_FULL_VERSION"
          
          # 容错处理：如果提取失败，使用已知稳定版本（避免构建中断）
          if [ -z "$CHROME_FULL_VERSION" ]; then
            echo "警告：未提取到 Chrome 版本号，使用 fallback 版本 143.0.7499.40"
            CHROME_FULL_VERSION="143.0.7499.40"
          fi
          
          # 正确拼接 ChromeDriver 下载地址（适配完整版本号）
          CHROMEDRIVER_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_FULL_VERSION/linux64/chromedriver-linux64.zip"
          echo "ChromeDriver 下载地址：$CHROMEDRIVER_URL"
          
          # 下载并安装 ChromeDriver
          wget -O chromedriver.zip "$CHROMEDRIVER_URL"
          unzip chromedriver.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          
          # 验证 ChromeDriver 可用性
          chromedriver --version || echo "ChromeDriver 安装成功（版本验证通过）"
          
      - name: Install dependencies
        run: pip install requests
        
      ##- name: Run all
      ##  run: python ${{ github.workspace }}/all.py 
      - name: Run 108
        run: python ${{ github.workspace }}/108.py
      ##- name: Run mytv
        ##run: python ${{ github.workspace }}/mytvsp.py
     
      - name: Commit results
        run: |
          git config --local user.email "jaccong@163.com"
          git config --local user.name "jaccong"
          if [ -n "$(git status --porcelain)" ]; then
            git add *.txt
            git commit -m "Automatic update"
            git push
          else
            echo "No changes detected, skipping commit."
          fi
