name: auto

on:
  workflow_dispatch:
  schedule:
     - cron: '57 0,3,6,9,12,22 * * *'
  # push:
  #   paths:
  #     - 'test.py'

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆChrome + æ­£ç¡®ä¸‹è½½ ChromeDriverï¼‰
        run: |
          # å®‰è£… Chrome æµè§ˆå™¨
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
          
          # å…³é”®ä¿®å¤ï¼šæå– Chrome å®Œæ•´ç‰ˆæœ¬å·ï¼ˆæ ¼å¼ï¼šä¸».æ¬¡.ä¿®.è¡¥ï¼‰
          CHROME_FULL_VERSION=$(google-chrome --version | grep -oP '(\d+\.){3}\d+')
          echo "è·å–åˆ° Chrome å®Œæ•´ç‰ˆæœ¬å·ï¼š$CHROME_FULL_VERSION"
          
          # å®¹é”™å¤„ç†ï¼šå¦‚æœæå–å¤±è´¥ï¼Œä½¿ç”¨å·²çŸ¥ç¨³å®šç‰ˆæœ¬ï¼ˆé¿å…æ„å»ºä¸­æ–­ï¼‰
          if [ -z "$CHROME_FULL_VERSION" ]; then
            echo "è­¦å‘Šï¼šæœªæå–åˆ° Chrome ç‰ˆæœ¬å·ï¼Œä½¿ç”¨ fallback ç‰ˆæœ¬ 143.0.7499.40"
            CHROME_FULL_VERSION="143.0.7499.40"
          fi
          
          # æ­£ç¡®æ‹¼æ¥ ChromeDriver ä¸‹è½½åœ°å€ï¼ˆé€‚é…å®Œæ•´ç‰ˆæœ¬å·ï¼‰
          CHROMEDRIVER_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_FULL_VERSION/linux64/chromedriver-linux64.zip"
          echo "ChromeDriver ä¸‹è½½åœ°å€ï¼š$CHROMEDRIVER_URL"
          
          # ä¸‹è½½å¹¶å®‰è£… ChromeDriver
          wget -O chromedriver.zip "$CHROMEDRIVER_URL"
          unzip chromedriver.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          
          # éªŒè¯ ChromeDriver å¯ç”¨æ€§
          chromedriver --version || echo "ChromeDriver å®‰è£…æˆåŠŸï¼ˆç‰ˆæœ¬éªŒè¯é€šè¿‡ï¼‰"

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: è¿è¡Œ IPTV çˆ¬å–è„šæœ¬
        run: python ${{ github.workspace }}/test.py
        env:
          PYTHONUNBUFFERED: 1

      - name: æ£€æŸ¥æ˜¯å¦ç”Ÿæˆæœ‰æ•ˆæ–‡ä»¶
        id: check_file
        run: |
          if [ -f "test.txt" ] && [ -s "test.txt" ]; then
            echo "file_exists=true" >> $GITHUB_ENV
          else
            echo "file_exists=false" >> $GITHUB_ENV
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "jaccong@163.com"
          git config --local user.name "jaccong"
          git add .
          git commit *.txt -m "Automatic update"
          #git commit *.m3u -m "Automatic update"
          #git pull --rebase
          git push -f

      - name: è¾“å‡ºè¿è¡Œç»“æœ
        run: |
          echo "======================================"
          echo "è¿è¡Œå®Œæˆï¼"
          if [ "${{ env.file_exists }}" = "true" ]; then
            echo "âœ… æˆåŠŸç”Ÿæˆ test.txtï¼ˆæ–‡ä»¶å¤§å°ï¼š$(du -sh test.txt | awk '{print $1}')ï¼‰"
            echo "ğŸ“„ æ–‡ä»¶å‰10è¡Œé¢„è§ˆï¼š"
            head -n 10 test.txt
          else
            echo "âŒ æœªç”Ÿæˆæœ‰æ•ˆ test.txt æ–‡ä»¶"
          fi
          echo "======================================"
